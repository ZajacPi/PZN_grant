#include<mpu6050.h>
#include<main.h>
extern I2C_HandleTypeDef hi2c1;

void mpu6050_init(){
	  printf(".................................................\n");
	printf("Checking connection...\n");
	  HAL_StatusTypeDef ret = HAL_I2C_IsDeviceReady(&hi2c1, MPU6050_ADDR, 1, 100);
	  if (ret == HAL_OK){
		  printf("Device ready!\n");
	  }
	  else{
		  printf("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n");
		  printf("Device not detected. Check connection.\n");
		  printf("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n");
	  }
	  uint8_t temp_data = 0b00001000; // set to
	  ret = HAL_I2C_Mem_Write(&hi2c1, MPU6050_ADDR, CONFIG_GYRO, 1, &temp_data, 1, 100);
	  if (ret == HAL_OK){
		  printf("Gyroscope configured!\n");
	  }
	  else{
		  printf("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n");
		  printf("Cannot configure gyroscope.\n");
		  printf("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n");
	  }
	   temp_data = 0b00001000; // set to +- 4g
		  ret = HAL_I2C_Mem_Write(&hi2c1, MPU6050_ADDR, CONFIG_ACC, 1, &temp_data, 1, 100);
		  if (ret == HAL_OK){
			  printf("Accelerometer configured!\n");
		  }
		  else{
			  printf("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n");
			  printf("Cannot configure accelerometer.\n");
			  printf("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n");
		  }

	  temp_data = 0b00001000; // set to +- 4g
		  ret = HAL_I2C_Mem_Write(&hi2c1, MPU6050_ADDR, PWR_MANAGEMENT, 1, &temp_data, 1, 100);
		  if (ret == HAL_OK){
			  printf("Power management successful,thermometer turned off, exit sleep mode!\n");
		  }
		  else{
			  printf("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n");
			  printf("Cannot configure power management.\n");
			  printf("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n");
		  }
}
void mpu6050_read (){
	uint8_t data_buffer[2];
	int16_t x_acc;
	HAL_I2C_Mem_Read(&hi2c1, MPU6050_ADDR, DATA+1, 1, data_buffer, 2, 100);
	x_acc = ((int16_t)data_buffer[0] << 8) | data_buffer[1];
	printf("x axis acceleration: %d\n", x_acc);
}
